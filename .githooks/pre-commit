#!/bin/bash

# 定义颜色以便在终端中突出显示
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}🔍 正在执行 pre-commit 钩子：检查敏感信息...${NC}"

# 定义要检查的正则表达式模式 (可根据需要自行增删)
PATTERNS=(
  # 1. 匹配常见的 Bearer Token (考虑到你的项目中有很多 API 调用)
  'Bearer [a-zA-Z0-9\-\._~\+\/]{20,2}'
  
  # 2. 匹配硬编码的滴答清单 Token 赋值操作 (例如：accessToken = "ey...")
  # 排除掉获取环境变量的操作 (如 process.env.DIDA365_ACCESS_TOKEN)
  '(DIDA365_ACCESS_TOKEN|TICKTICK_ACCESS_TOKEN)\s*=\s*['\''"][a-zA-Z0-9\-\._~\+\/]{10,}['\''"]'
  
  # 3. 匹配通用的 API Key、Secret、Password 赋值操作
  # 匹配形如 api_key = "sk-..." 或 password: 'my-pass' 的硬编码字符串
  '(api[_-]?key|secret[_-]?key|password|access[_-]?token)\s*[:=]\s*['\''"][a-zA-Z0-9\-\._~\+\/]{8,}['\''"]'
  
  # 4. AWS Access Key ID
  'AKIA[0-9A-Z]{16}'
  
  # 5. 私钥文件标头
  '-----BEGIN (RSA|OPENSSH|DSA|EC|PGP) PRIVATE KEY-----'
)

# 获取当前暂存区 (staged) 中被修改或新增的文件列表
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

HAS_ERROR=0

for FILE in $STAGED_FILES; do
  # 如果你想连文档一起查，可以把这几行注释掉
  # if [[ "$FILE" == *.md ]]; then
  #   continue
  # fi

  for PATTERN in "${PATTERNS[@]}"; do
    # 使用 git grep 在暂存区的内容中搜索模式
    # --cached: 只检查 staged 的内容
    # -E: 使用扩展正则表达式
    # -n: 显示行号
    # -I: 忽略二进制文件
    MATCHES=$(git grep --cached -E -n -I "$PATTERN" -- "$FILE")
    
    if [ ! -z "$MATCHES" ]; then
      echo -e "${RED}❌ 拦截：在将要提交的文件 $FILE 中检测到疑似个人敏感信息！${NC}"
      
      # 输出匹配到的具体行
      echo "$MATCHES" | sed 's/^/   -> /'
      
      HAS_ERROR=1
    fi
  done
done

if [ $HAS_ERROR -eq 1 ]; then
  echo -e "\n${RED}⚠️  提交被拒绝 (Commit Rejected)。请移除上述敏感信息后再尝试提交。${NC}"
  echo -e "${YELLOW}💡 如果你确定这是测试用的假数据（误报），可以使用 'git commit --no-verify' 来强制跳过此检查。${NC}"
  exit 1
fi

echo -e "${GREEN}✅ 敏感信息检查通过，未发现异常。${NC}"
exit 0