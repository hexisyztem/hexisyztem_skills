# 米家（Mi Home）接入技术方案

## 📋 文档信息

- **创建日期**: 2026-02-25
- **版本**: v1.0
- **状态**: 规划中

## 🎯 目标

实现对米家智能设备的编程控制，并与滴答清单联动，构建自动化场景。

## 🔍 技术调研

### 方案一：小米 IoT 开放平台（官方 API）

**优点：**
- ✅ 官方支持，稳定可靠
- ✅ 云端控制，无需局域网
- ✅ 完善的文档和 SDK

**缺点：**
- ❌ 需要申请开发者账号
- ❌ 需要设备厂商授权
- ❌ 审核流程较长

**官方资源：**
- 开放平台：https://iot.mi.com/
- 开发文档：https://iot.mi.com/new/doc/

### 方案二：miio 库（社区方案）

**优点：**
- ✅ 成熟的开源项目
- ✅ 支持本地控制，响应快
- ✅ 支持多种设备类型
- ✅ Node.js 生态友好

**缺点：**
- ❌ 需要获取设备 token
- ❌ 部分新设备可能不支持
- ❌ 依赖社区维护

**资源链接：**
- NPM: https://www.npmjs.com/package/miio
- GitHub: https://github.com/aholstenson/miio

### 方案三：Home Assistant 集成

**优点：**
- ✅ 完整的智能家居平台
- ✅ 支持米家等多个生态
- ✅ 强大的自动化引擎

**缺点：**
- ❌ 需要额外部署服务
- ❌ 学习成本较高
- ❌ 可能超出轻量级需求

## ✅ 推荐方案

**选择方案二：miio 库**

**理由：**
1. 符合项目"轻量级接入"的理念
2. Node.js 技术栈一致
3. 快速上手，无需复杂审核流程
4. 社区活跃，问题易解决

## 📝 实施步骤

### 第一阶段：环境搭建与认证（1-2天）

1. **安装 miio 库**
   ```bash
   npm install miio
   ```

2. **获取设备 token**
   - 方法1：使用 miio 命令行工具发现设备
   - 方法2：通过抓包工具获取
   - 方法3：使用第三方工具（如 Mi Home Token Extractor）

3. **实现认证模块**
   - 保存设备信息（IP、token、型号）
   - 实现设备连接逻辑

### 第二阶段：基础功能开发（2-3天）

1. **设备发现与列表**
   - 自动发现局域网内的米家设备
   - 显示设备信息和状态

2. **设备控制**
   - 实现基础控制命令（开关、亮度、温度等）
   - 支持不同设备类型

3. **状态查询**
   - 实时查询设备状态
   - 格式化输出

### 第三阶段：高级功能（2-3天）

1. **场景触发**
   - 定义智能场景
   - 批量控制多个设备

2. **自动化联动**
   - 与滴答清单集成
   - 基于日程触发设备控制

3. **MCP Server 集成**
   - 为 Gemini CLI 提供工具接口

## 📊 技术栈

- **语言**: JavaScript (Node.js)
- **核心库**: miio
- **辅助库**: @modelcontextprotocol/sdk
- **通信协议**: UDP (miio 协议)

## 🔐 安全考虑

1. **Token 保护**: 使用环境变量存储敏感信息
2. **本地控制**: 优先使用局域网控制，避免云端数据泄露
3. **权限最小化**: 只请求必要的设备权限

## 📅 时间规划

- **第一周**: 技术调研与方案确定 ✅
- **第二周**: 基础功能开发
- **第三周**: 高级功能与联动
- **第四周**: 测试与文档完善

## 🎯 成功标准

1. ✅ 能够发现并列出米家设备
2. ✅ 能够控制至少 3 种类型的设备
3. ✅ 实现至少 2 个自动化场景
4. ✅ 完成与滴答清单的联动
5. ✅ 提供完整的使用文档

## 📚 参考资源

- [miio 官方文档](https://github.com/aholstenson/miio)
- [小米 IoT 协议分析](https://github.com/OpenMiHome/mihome-binary-protocol)
- [米家设备列表](https://home.miot-spec.com/)
